<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>TPV Bar Versio 21</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
    h1 { text-align: center; }
    .container { display: flex; gap: 20px; align-items: flex-start; }
    .productos, .pedido { flex: 1; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,.06); }
    .categorias { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
    .categorias button { padding: 8px 12px; cursor: pointer; border: 1px solid #ddd; background: #fafafa; border-radius: 6px; }
    #listaProductos { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
    .producto { border: 1px solid #ddd; border-radius: 8px; padding: 10px; text-align: center; background: #fff; cursor: pointer; }
    .producto img { max-width: 80px; display: block; margin: 6px auto 8px; }

    table { width: 100%; border-collapse: collapse; margin-top: 10px; background: #fff; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    .total { font-size: 18px; font-weight: bold; margin-top: 10px; }

    .btn { padding: 8px 12px; margin: 5px 5px 0 0; cursor: pointer; border-radius: 6px; border: none; background: #eee; }
    .btn-pay { background: #2e7d32; color: #fff; }
    .btn-voz { background: #007bff; color: #fff; }

    #voz-texto { font-style: italic; color: #666; margin-top: 6px; min-height: 22px; }
    #voz-control { margin-top: 10px; display: flex; align-items: center; }
    #mic-icon { display: none; font-size: 22px; margin-left: 10px; vertical-align: middle; animation: blink 1s infinite; }
    @keyframes blink { 0% {opacity: 1;} 50% {opacity: .2;} 100% {opacity: 1;} }
    .btn-listening { background: #d32f2f !important; color: #fff !important; }

    /* ===== Modales (gesti√≥n / historial) ===== */
    #modal-gestion, #modal-historial {
      display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5);
      align-items:center; justify-content:center; padding: 10px; z-index: 999;
    }
    .modal-card { background:#fff; width:min(980px, 96vw); max-height: 92vh; overflow:auto; border-radius:12px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.2); }
    .modal-head { display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:10px; }
    .modal-head h3 { margin:0; }
    .modal-body { display:grid; gap:12px; }
    .form-grid { display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; }
    .form-grid input { width:100%; padding:8px; border:1px solid #ddd; border-radius:6px; }
    .table-gestion { width:100%; border-collapse:collapse; }
    .table-gestion th, .table-gestion td { border:1px solid #eee; padding:8px; }
    .chip { display:inline-block; padding:2px 8px; border-radius:10px; background:#f2f2f2; }

    /* Historial filtros */
    .filtros { display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; }
    .filtros input { padding:8px; border:1px solid #ddd; border-radius:6px; }
    .acciones-hist { display:flex; gap:8px; flex-wrap:wrap; }

    /* Toast */
    #toast { position: fixed; top: 14px; right: 14px; background:#333; color:#fff; padding:10px 14px; border-radius:8px; display:none; z-index: 1000; }
  </style>
</head>
<body>
  <h1>TPV Bar</h1>

  <div class="container">
    <!-- Lado productos -->
    <div class="productos">
      <h2>Productos</h2>
      <div class="categorias" id="categorias"></div>
      <div id="listaProductos"></div>

      <!-- Voz -->
      <div id="voz-control">
        <button class="btn" id="btn-hablar" onclick="iniciarVoz()">üé§ Pedir por voz</button>
        <span id="mic-icon" title="Escuchando‚Ä¶">üéôÔ∏è</span>
      </div>
      <p id="voz-texto"></p>
    </div>

    <!-- Lado pedido -->
    <div class="pedido">
      <h2>Pedido</h2>
      <button class="btn-voz" id="btn-voz" onclick="toggleConfirmacionVoz()">Confirmaci√≥n en voz: S√≠</button>
      <button class="btn" onclick="abrirGestion()">üõ†Ô∏è Gesti√≥n de productos</button>
      <button class="btn" onclick="abrirHistorial()">üìú Historial de tickets</button>

      <table id="tablaPedido">
        <thead>
          <tr><th>Producto</th><th>Cant.</th><th>Precio</th><th>Total</th><th>Acci√≥n</th></tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="total" id="totalPedido">Total: 0 ‚Ç¨</div>
      <div>
        <button class="btn btn-pay" onclick="pagar('Efectivo')">Pagar en efectivo</button>
        <button class="btn btn-pay" onclick="pagar('Tarjeta')">Pagar con tarjeta</button>
        <button class="btn" onclick="borrarPedido()">Borrar pedido</button>
        <button class="btn" onclick="imprimirTicket()">üßæ Imprimir ticket</button>
      </div>
    </div>
  </div>

  <!-- ============ Modal Gesti√≥n de Productos ============ -->
  <div id="modal-gestion">
    <div class="modal-card">
      <div class="modal-head">
        <h3>Gesti√≥n de productos</h3>
        <button class="btn" onclick="cerrarGestion()">‚úñ Cerrar</button>
      </div>
      <div class="modal-body">
        <div class="form-grid">
          <input id="gp-nombre" type="text" placeholder="Nombre *" />
          <input id="gp-categoria" type="text" placeholder="Categor√≠a *" />
          <input id="gp-precio" type="number" step="0.01" min="0" placeholder="Precio *" />
          <input id="gp-imagen" type="url" placeholder="URL imagen (opcional)" />
        </div>
        <div>
          <button class="btn-voz" id="gp-guardar" onclick="guardarProductoGestion()">‚ûï A√±adir</button>
          <button class="btn" onclick="limpiarFormularioGestion()">Limpiar</button>
          <span class="chip" id="gp-modo">Modo: crear</span>
          <button class="btn" style="float:right" onclick="resetearProductos()">‚Ü©Ô∏è Restaurar carta por defecto</button>
        </div>

        <table class="table-gestion" id="tabla-gestion">
          <thead>
            <tr>
              <th>#</th><th>Nombre</th><th>Categor√≠a</th><th>Precio</th><th>Imagen</th><th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ============ Modal Historial de Tickets ============ -->
  <div id="modal-historial">
    <div class="modal-card">
      <div class="modal-head">
        <h3>Hist√≥rico de tickets</h3>
        <button class="btn" onclick="cerrarHistorial()">‚úñ Cerrar</button>
      </div>
      <div class="modal-body">
        <div class="filtros">
          <input id="f-num" type="number" min="1" placeholder="N¬∫ ticket" />
          <input id="f-desde" type="date" />
          <input id="f-hasta" type="date" />
          <div class="acciones-hist">
            <button class="btn" onclick="aplicarFiltrosHistorial()">Filtrar</button>
            <button class="btn" onclick="limpiarFiltrosHistorial()">Limpiar</button>
            <button class="btn" onclick="exportarTicketsCSV()">Exportar CSV</button>
          </div>
        </div>

        <table class="table-gestion" id="tabla-historial">
          <thead>
            <tr>
              <th>#</th><th>Fecha</th><th>Items</th><th>Subtotal</th><th>IVA</th><th>Total</th><th>Pago</th><th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="toast"></div>

  <script>
    // ========= Persistencia =========
    const LS_KEYS = {
      productos: "tpv_productos_v1",
      categoria: "tpv_categoria_v1",
      pedido: "tpv_pedido_v1",
      vozConfirm: "tpv_confirm_voz_v1",
      tickets: "tpv_tickets_v1",
      ticketSeq: "tpv_ticket_seq_v1"
    };

    const cartaPorDefecto = [
      {categoria:"Cervezas", nombre:"Cerveza Mahou", precio:2.0, img:"https://via.placeholder.com/80?text=Mahou"},
      {categoria:"Cervezas", nombre:"Cerveza Estrella", precio:2.2, img:"https://via.placeholder.com/80?text=Estrella"},
      {categoria:"Refrescos", nombre:"CocaCola", precio:1.8, img:"https://via.placeholder.com/80?text=CocaCola"},
      {categoria:"Refrescos", nombre:"Limonada", precio:1.5, img:"https://via.placeholder.com/80?text=Limonada"},
      {categoria:"Refrescos", nombre:"RedBull", precio:2.5, img:"https://via.placeholder.com/80?text=RedBull"},
      {categoria:"Combinados", nombre:"Gin Tonic", precio:6.0, img:"https://via.placeholder.com/80?text=Gin+Tonic"},
      {categoria:"Combinados", nombre:"Ron Cola", precio:5.5, img:"https://via.placeholder.com/80?text=Ron+Cola"},
      {categoria:"Chupitos", nombre:"Chupito Tequila", precio:2.0, img:"https://via.placeholder.com/80?text=Tequila"},
      {categoria:"Chupitos", nombre:"Chupito Vodka", precio:2.0, img:"https://via.placeholder.com/80?text=Vodka"},
      {categoria:"Chupitos", nombre:"Chupito J√§ger", precio:2.2, img:"https://via.placeholder.com/80?text=Jager"}
    ];

    const loadJSON = (k, fallback=null)=>{ try{ const r=localStorage.getItem(k); return r?JSON.parse(r):fallback; }catch(e){ return fallback; } };
    const saveJSON = (k, v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){} };

    // Estado
    let productos = loadJSON(LS_KEYS.productos, null) ?? cartaPorDefecto.slice();
    if(!loadJSON(LS_KEYS.productos, null)) saveJSON(LS_KEYS.productos, productos);
    let categorias = [];
    let currentCategoria = loadJSON(LS_KEYS.categoria, null);
    let pedido = loadJSON(LS_KEYS.pedido, []);
    let confirmacionVoz = loadJSON(LS_KEYS.vozConfirm, true);
    let tickets = loadJSON(LS_KEYS.tickets, []);
    let ticketSeq = loadJSON(LS_KEYS.ticketSeq, 1);

    // ====== Utilidades ======
    function toast(msg, ms=1800){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=> t.style.display='none', ms); }
    function formateaFecha(d=new Date()){ const pad=n=>String(n).padStart(2,'0'); return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }
    function getNextTicketNumber(){ const n=ticketSeq; ticketSeq=n+1; saveJSON(LS_KEYS.ticketSeq,ticketSeq); return n; }
    function calcularResumenPedido(ped){ let subtotal=0; ped.forEach(p=> subtotal+=p.precio*p.cantidad); const iva=subtotal*0.10; const total=subtotal+iva; return {subtotal:+subtotal.toFixed(2), iva:+iva.toFixed(2), total:+total.toFixed(2)}; }
    function crearYGuardarTicket(metodoPago=""){ if(pedido.length===0) return null; const numero=getNextTicketNumber(); const fechaISO=new Date().toISOString(); const tot=calcularResumenPedido(pedido);
      const ticket={numero,fechaISO,fecha:formateaFecha(new Date(fechaISO)),metodoPago,items:pedido.map(p=>({nombre:p.nombre,cantidad:p.cantidad,precio:p.precio,total:(p.precio*p.cantidad)})),subtotal:tot.subtotal,iva:tot.iva,total:tot.total};
      tickets.push(ticket); saveJSON(LS_KEYS.tickets,tickets); toast(`Ticket #${numero} guardado${metodoPago?` (${metodoPago})`:""}`); return ticket; }

    // ====== Asegurar ‚ÄúChupito Vodka‚Äù si faltaba ======
    (function ensureDefaults(){
      const want = "Chupito Vodka";
      if(!productos.some(p=>p.nombre===want)){ productos.push({categoria:"Chupitos", nombre:want, precio:2.0, img:"https://via.placeholder.com/80?text=Vodka"}); saveJSON(LS_KEYS.productos, productos); }
    })();

    // ====== Categor√≠as / Productos ======
    function recalcularCategorias(){
      categorias=[...new Set(productos.map(p=>p.categoria))].sort();
      if(!currentCategoria || !categorias.includes(currentCategoria)){ currentCategoria=categorias[0]||null; }
      saveJSON(LS_KEYS.categoria,currentCategoria);
    }
    function cargarCategorias(){
      recalcularCategorias();
      const cont=document.getElementById("categorias"); cont.innerHTML="";
      categorias.forEach(cat=>{
        const b=document.createElement("button");
        b.textContent=cat+(cat===currentCategoria?" ‚úì":"");
        b.onclick=()=>{ currentCategoria=cat; saveJSON(LS_KEYS.categoria,currentCategoria); mostrarProductos(currentCategoria); cargarCategorias(); };
        cont.appendChild(b);
      });
    }
    function mostrarProductos(cat){
      const grid=document.getElementById("listaProductos"); grid.innerHTML=""; if(!cat) return;
      productos.filter(p=>p.categoria===cat).forEach(p=>{
        const card=document.createElement("div"); card.className="producto"; card.onclick=()=>agregarPedidoProducto(p);
        card.innerHTML=`<img src="${p.img||'https://via.placeholder.com/80'}" alt="${p.nombre}"><div>${p.nombre}</div><div>${p.precio.toFixed(2)} ‚Ç¨</div>`;
        grid.appendChild(card);
      });
    }

    // ====== Pedido ======
    function agregarPedidoProducto(producto, cantidad=1){
      const item=pedido.find(x=>x.nombre===producto.nombre);
      item? item.cantidad+=cantidad : pedido.push({...producto, cantidad});
      saveJSON(LS_KEYS.pedido, pedido); renderPedido();
      if(confirmacionVoz){ hablar(`${cantidad} ${producto.nombre}`); }
    }
    function eliminarLinea(index){ if(index<0||index>=pedido.length) return; pedido.splice(index,1); saveJSON(LS_KEYS.pedido,pedido); renderPedido(); }
    function renderPedido(){
      const tbody=document.querySelector("#tablaPedido tbody"); tbody.innerHTML=""; let total=0;
      pedido.forEach((p,i)=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${p.nombre}</td><td>${p.cantidad}</td><td>${p.precio.toFixed(2)} ‚Ç¨</td><td>${(p.cantidad*p.precio).toFixed(2)} ‚Ç¨</td><td><button class="btn" onclick="eliminarLinea(${i})">üóëÔ∏è</button></td>`;
        tbody.appendChild(tr); total+=p.cantidad*p.precio;
      });
      document.getElementById("totalPedido").textContent="Total: "+total.toFixed(2)+" ‚Ç¨";
    }
    function pagar(metodo){
      if(pedido.length===0){ alert("No hay productos en el pedido."); return; }
      crearYGuardarTicket(metodo);
      pedido=[]; saveJSON(LS_KEYS.pedido,pedido); renderPedido();
      alert("Pedido pagado con " + metodo);
    }
    function borrarPedido(){ if(confirm("¬øBorrar todo el pedido?")){ pedido=[]; saveJSON(LS_KEYS.pedido,pedido); renderPedido(); } }

    // ====== Confirmaci√≥n por voz (TTS) ======
    function toggleConfirmacionVoz(){ confirmacionVoz=!confirmacionVoz; document.getElementById("btn-voz").textContent=`Confirmaci√≥n en voz: ${confirmacionVoz?'S√≠':'No'}`; saveJSON(LS_KEYS.vozConfirm,confirmacionVoz); }
    function hablar(texto){ if('speechSynthesis' in window){ const msg=new SpeechSynthesisUtterance(texto); msg.lang='es-ES'; window.speechSynthesis.speak(msg); } }

    // ====== Reconocimiento de voz (STT) + int√©rprete ‚ÄúIA‚Äù ======
    let recognition;

    // --------- Helpers NLP ----------
    const NUM_PAL = { un:1, una:1, uno:1, dos:2, tres:3, cuatro:4, cinco:5, seis:6, siete:7, ocho:8, nueve:9, diez:10 };
    const MISSPELLINGS = [
      [/vozka|voska|boska|vodca|vodcka/g, "vodka"],
      [/coca[\s-]*cola/g, "cocacola"],
      [/red[\s-]*bull/g, "redbull"],
      [/jag+er|ja?gger|yager/g, "jager"],   // normalizamos a "jager"
      [/roncola|ron-?cola/g, "ron cola"]
    ];
    const STOPWORDS = new Set(["ponme","pon","me","por","favor","porfa","quiero","trae","traeme","tr√°eme","dame","para","de","del","la","el","los","las","ademas","adem√°s"]);

    function norm(str){
      let s=(str||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
      MISSPELLINGS.forEach(([re,rep])=> s=s.replace(re,rep));
      return s.replace(/\s+/g,' ').trim();
    }

    // Levenshtein + similitud
    function lev(a,b){
      const m=a.length,n=b.length; const dp=Array.from({length:m+1},()=>Array(n+1).fill(0));
      for(let i=0;i<=m;i++) dp[i][0]=i; for(let j=0;j<=n;j++) dp[0][j]=j;
      for(let i=1;i<=m;i++){ for(let j=1;j<=n;j++){ const cost=a[i-1]===b[j-1]?0:1; dp[i][j]=Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost); }}
      return dp[m][n];
    }
    function similarity(a,b){ a=norm(a); b=norm(b); if(!a||!b) return 0; const d=lev(a,b); return 1 - d / Math.max(a.length,b.length); }

    function productAliases(pname){
      const n=norm(pname);
      const aliases=new Set([n]);
      aliases.add(n.replace(/coca\s*cola/,"cocacola"));
      aliases.add(n.replace(/\s+/g,'')); // ‚Äúron cola‚Äù -> ‚Äúroncola‚Äù
      if(n.includes("chupito")){
        aliases.add(n.replace("chupito ",""));
        aliases.add(n.replace("chupitos ",""));
        aliases.add(n.replace("chupito ","")+" chupito");
      }
      return Array.from(aliases);
    }
    function encontrarProducto(frase){
      let best=null,score=0; const q=norm(frase);
      for(const p of productos){
        for(const cand of productAliases(p.nombre)){
          const s=similarity(q,cand); if(s>score){ score=s; best=p; }
        }
      }
      return score>=0.55? best : null;
    }
    function qtyFromToken(tok){ if(!tok) return null; if(/^\d+$/.test(tok)) return parseInt(tok,10); if(NUM_PAL.hasOwnProperty(tok)) return NUM_PAL[tok]; return null; }
    function isSep(tok){ return tok==='|' || tok===',' || tok===';'; }

    function normalizePhrase(words, sawChupito){
      const core = words.filter(w=>!STOPWORDS.has(w) && w!=='de').map(w=>{
        if(w.endsWith("es")) return w.slice(0,-2);
        if(w.endsWith("s")) return w.slice(0,-1);
        return w;
      }).join(' ').trim();

      let frase = core;
      const rules = [
        [/^vodka$/, "chupito vodka"],
        [/^tequila$/, "chupito tequila"],
        [/^jager$/, "chupito jager"],
        [/^gintonic$|^gin tonic$/, "gin tonic"],
        [/^coca?cola$/, "cocacola"],
        [/^redbull$/, "redbull"],
        [/^roncola$|^ron cola$/, "ron cola"]
      ];
      for(const [re,rep] of rules){ if(re.test(frase)) frase=rep; }
      if(sawChupito && frase && !frase.startsWith("chupito")) frase="chupito "+frase;
      return frase;
    }

    function interpretarPedidoVoz(texto){
      const t = norm(texto).replace(/[,;]+/g,' | ').replace(/\s+y\s+/g,' | ').replace(/\s+e\s+/g,' | ');
      const segments = t.split('|').map(s=>s.trim()).filter(Boolean);
      const items = [];

      for(const seg of segments){
        const tokens = seg.split(/\s+/).filter(Boolean);
        for(let i=0;i<tokens.length;i++){
          let q = qtyFromToken(tokens[i]);
          if(q==null) continue;

          // recolectar palabras hasta pr√≥xima cantidad/sep
          let buf=[], sawChupito=false, j=i+1;
          while(j<tokens.length && qtyFromToken(tokens[j])==null && !isSep(tokens[j])){
            const w=tokens[j];
            if(w==='chupito'||w==='chupitos'){ sawChupito=true; j++; continue; }
            buf.push(w); j++;
          }
          // caso "dos chupitos" + "de vodka"
          if(buf.length===0 && i>0 && (tokens[i-1]==='chupito'||tokens[i-1]==='chupitos')){
            sawChupito=true;
            if(j<tokens.length && tokens[j]==='de' && j+1<tokens.length){ buf.push(tokens[j+1]); j+=2; }
          }

          const frase = normalizePhrase(buf, sawChupito);
          if(frase){
            const prod = encontrarProducto(frase);
            if(prod){ items.push({producto:prod, cantidad:q}); }
          }
          i = j-1; // saltar lo ya consumido
        }
      }
      return items;
    }

    function iniciarVoz(){
      const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
      if(!SR){ alert("Tu navegador no soporta reconocimiento de voz."); return; }
      recognition=new SR(); recognition.lang="es-ES"; recognition.continuous=false; recognition.interimResults=false;

      recognition.onstart=()=>{
        document.getElementById("voz-texto").textContent="üéôÔ∏è Escuchando...";
        document.getElementById("mic-icon").style.display="inline";
        document.getElementById("btn-hablar").classList.add("btn-listening");
      };
      recognition.onresult=(e)=>{
        const texto=e.results[0][0].transcript;
        document.getElementById("voz-texto").textContent="Has dicho: "+texto;

        if(norm(texto).includes("borrar pedido")){ borrarPedido(); return; }

        const interpretados = interpretarPedidoVoz(texto);
        if(interpretados.length===0){ toast("No he reconocido productos en el dictado."); return; }
        interpretados.forEach(it=> agregarPedidoProducto(it.producto, it.cantidad));
      };
      recognition.onerror=(ev)=>{ document.getElementById("voz-texto").textContent="Error: "+ev.error; };
      recognition.onend=()=>{
        document.getElementById("voz-texto").textContent+=" ‚úÖ";
        document.getElementById("mic-icon").style.display="none";
        document.getElementById("btn-hablar").classList.remove("btn-listening");
      };
      recognition.start();
    }

    // ====== Gesti√≥n de productos ======
    let editIndex=null;
    function abrirGestion(){ document.getElementById("modal-gestion").style.display="flex"; limpiarFormularioGestion(); renderGestion(); }
    function cerrarGestion(){ document.getElementById("modal-gestion").style.display="none"; }
    function gp(id){ return document.getElementById('gp-'+id); }
    function limpiarFormularioGestion(){ editIndex=null; gp('nombre').value=""; gp('categoria').value=""; gp('precio').value=""; gp('imagen').value=""; document.getElementById("gp-guardar").textContent="‚ûï A√±adir"; document.getElementById("gp-modo").textContent="Modo: crear"; }
    function cargarProductoEnFormulario(i){
      const p=productos[i]; gp('nombre').value=p.nombre; gp('categoria').value=p.categoria; gp('precio').value=p.precio; gp('imagen').value=p.img||"";
      document.getElementById("gp-guardar").textContent="üíæ Guardar"; document.getElementById("gp-modo").textContent="Modo: editar"; editIndex=i;
    }
    function guardarProductoGestion(){
      const nombre=gp('nombre').value.trim(), categoria=gp('categoria').value.trim(), precio=parseFloat(gp('precio').value), img=gp('imagen').value.trim();
      if(!nombre||!categoria||isNaN(precio)){ alert("Rellena nombre, categor√≠a y precio correctamente."); return; }
      if(editIndex===null){ productos.push({nombre,categoria,precio,img}); } else { productos[editIndex]={nombre,categoria,precio,img}; }
      saveJSON(LS_KEYS.productos, productos); limpiarFormularioGestion(); renderGestion(); cargarCategorias(); mostrarProductos(currentCategoria);
    }
    function borrarProductoGestion(i){ if(!confirm("¬øEliminar este producto?")) return; productos.splice(i,1); saveJSON(LS_KEYS.productos,productos); renderGestion(); cargarCategorias(); mostrarProductos(currentCategoria); }
    function resetearProductos(){ if(!confirm("Esto sustituir√° tus productos por la carta por defecto. ¬øContinuar?")) return; productos=cartaPorDefecto.slice(); saveJSON(LS_KEYS.productos,productos); limpiarFormularioGestion(); renderGestion(); cargarCategorias(); mostrarProductos(currentCategoria); }
    function renderGestion(){
      const tbody=document.querySelector("#tabla-gestion tbody"); tbody.innerHTML="";
      productos.forEach((p,i)=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${i+1}</td><td>${p.nombre}</td><td>${p.categoria}</td><td>${p.precio.toFixed(2)} ‚Ç¨</td><td>${p.img?'<a href="'+p.img+'" target="_blank">Ver</a>':'‚Äî'}</td>
          <td><button class="btn" onclick="cargarProductoEnFormulario(${i})">‚úèÔ∏è Editar</button><button class="btn" onclick="borrarProductoGestion(${i})">üóëÔ∏è Borrar</button></td>`;
        tbody.appendChild(tr);
      });
    }

    // ====== Ticket: imprimir, historial ======
    function imprimirTicket(){
      if(pedido.length===0){ alert("No hay productos en el pedido."); return; }
      const tot=calcularResumenPedido(pedido); const numero=getNextTicketNumber(); const fechaISO=new Date().toISOString();
      const ticket={numero,fechaISO,fecha:formateaFecha(new Date(fechaISO)),metodoPago:"",items:pedido.map(p=>({nombre:p.nombre,cantidad:p.cantidad,precio:p.precio,total:(p.precio*p.cantidad)})),subtotal:tot.subtotal,iva:tot.iva,total:tot.total};
      tickets.push(ticket); saveJSON(LS_KEYS.tickets,tickets);

      const lines=ticket.items.map(p=>`<tr><td>${p.cantidad} x ${p.nombre}</td><td style="text-align:right">${p.total.toFixed(2)}‚Ç¨</td></tr>`).join("");
      const html=`<html><head><meta charset="UTF-8"><style>
        body{font-family:monospace}.ticket{width:260px;margin:0 auto}h2,h3,p{margin:6px 0;text-align:center}
        table{width:100%;border-collapse:collapse;font-size:14px}td{padding:2px 0}.tot{border-top:1px dashed #000;margin-top:6px;padding-top:6px}
        @media print{@page{margin:6mm}}
      </style></head>
      <body onload="window.print(); setTimeout(()=>window.close(), 300);">
        <div class="ticket">
          <h2>BAR TPV</h2><p>Ticket #${ticket.numero}</p><p>${ticket.fecha}</p><hr/>
          <table>${lines}</table>
          <div class="tot"><table>
            <tr><td>Subtotal</td><td style="text-align:right">${ticket.subtotal.toFixed(2)}‚Ç¨</td></tr>
            <tr><td>IVA 10%</td><td style="text-align:right">${ticket.iva.toFixed(2)}‚Ç¨</td></tr>
            <tr><td><b>Total</b></td><td style="text-align:right"><b>${ticket.total.toFixed(2)}‚Ç¨</b></td></tr>
          </table></div>
          <hr/><h3>¬°Gracias por su visita!</h3>
        </div></body></html>`;
      const w=window.open("", "ticket", "width=350,height=600"); w.document.open(); w.document.write(html); w.document.close(); try{ w.focus(); }catch(e){}
      toast(`Ticket #${numero} guardado`);
    }

    function abrirHistorial(){ document.getElementById('modal-historial').style.display='flex'; renderHistorial(); }
    function cerrarHistorial(){ document.getElementById('modal-historial').style.display='none'; }
    function limpiarFiltrosHistorial(){ document.getElementById('f-num').value=''; document.getElementById('f-desde').value=''; document.getElementById('f-hasta').value=''; renderHistorial(); }
    function aplicarFiltrosHistorial(){ renderHistorial(); }
    function renderHistorial(){
      const tbody=document.querySelector('#tabla-historial tbody'); tbody.innerHTML='';
      const fNum=parseInt(document.getElementById('f-num').value||'0'); const fDesde=document.getElementById('f-desde').value; const fHasta=document.getElementById('f-hasta').value;
      const lista=[...tickets].sort((a,b)=> new Date(b.fechaISO)-new Date(a.fechaISO)).filter(t=>{
        let ok=true;
        if(fNum>0) ok=ok&&(t.numero===fNum);
        if(fDesde) ok=ok&&(new Date(t.fechaISO)>=new Date(fDesde+'T00:00:00'));
        if(fHasta) ok=ok&&(new Date(t.fechaISO)<=new Date(fHasta+'T23:59:59'));
        return ok;
      });
      lista.forEach(t=>{
        const itemsStr=t.items.map(i=>`${i.cantidad}x ${i.nombre}`).join(', ');
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${t.numero}</td><td>${t.fecha}</td><td style="text-align:left">${itemsStr}</td>
          <td>${t.subtotal.toFixed(2)}‚Ç¨</td><td>${t.iva.toFixed(2)}‚Ç¨</td><td><b>${t.total.toFixed(2)}‚Ç¨</b></td>
          <td>${t.metodoPago||'‚Äî'}</td><td><button class="btn" onclick="reimprimirTicket(${t.numero})">üñ®Ô∏è Reimprimir</button></td>`;
        tbody.appendChild(tr);
      });
      if(lista.length===0){ const tr=document.createElement('tr'); tr.innerHTML=`<td colspan="8" style="text-align:center;color:#666">No hay tickets para los filtros seleccionados.</td>`; tbody.appendChild(tr); }
    }
    function reimprimirTicket(numero){
      const t=tickets.find(x=>x.numero===numero); if(!t){ alert('Ticket no encontrado'); return; }
      const lines=t.items.map(p=>`<tr><td>${p.cantidad} x ${p.nombre}</td><td style="text-align:right">${(+p.total).toFixed(2)}‚Ç¨</td></tr>`).join("");
      const html=`<html><head><meta charset="UTF-8"><style>
        body{font-family:monospace}.ticket{width:260px;margin:0 auto}h2,h3,p{margin:6px 0;text-align:center}
        table{width:100%;border-collapse:collapse;font-size:14px}td{padding:2px 0}.tot{border-top:1px dashed #000;margin-top:6px;padding-top:6px}
        @media print{@page{margin:6mm}}
      </style></head>
      <body onload="window.print(); setTimeout(()=>window.close(), 300);">
        <div class="ticket">
          <h2>BAR TPV</h2><p>Ticket #${t.numero} (reimpresi√≥n)</p><p>${t.fecha}</p><p>Pago: ${t.metodoPago||'‚Äî'}</p><hr/>
          <table>${lines}</table>
          <div class="tot"><table>
            <tr><td>Subtotal</td><td style="text-align:right">${t.subtotal.toFixed(2)}‚Ç¨</td></tr>
            <tr><td>IVA 10%</td><td style="text-align:right">${t.iva.toFixed(2)}‚Ç¨</td></tr>
            <tr><td><b>Total</b></td><td style="text-align:right"><b>${t.total.toFixed(2)}‚Ç¨</b></td></tr>
          </table></div>
          <hr/><h3>¬°Gracias por su visita!</h3>
        </div></body></html>`;
      const w=window.open("", "ticket", "width=350,height=600"); w.document.open(); w.document.write(html); w.document.close(); try{ w.focus(); }catch(e){}
    }
    function exportarTicketsCSV(){
      const headers=["numero","fechaISO","fecha","metodoPago","items","subtotal","iva","total"];
      const rows=tickets.map(t=>{
        const items=t.items.map(i=>`${i.cantidad}x ${i.nombre} (${i.precio}‚Ç¨)`).join(" | ");
        return [t.numero,t.fechaISO,t.fecha,(t.metodoPago||''),items,t.subtotal,t.iva,t.total];
      });
      let csv=headers.join(",")+"\n"+rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(",")).join("\n");
      const a=document.createElement('a'); a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv); a.download='tickets.csv'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }

    // ====== Inicializaci√≥n ======
    (function init(){
      document.getElementById("btn-voz").textContent=`Confirmaci√≥n en voz: ${confirmacionVoz?'S√≠':'No'}`;
      recalcularCategorias(); cargarCategorias(); mostrarProductos(currentCategoria); renderPedido();
    })();
  </script>
</body>
</html>

